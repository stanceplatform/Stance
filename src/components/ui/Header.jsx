import React, { useState, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "../../context/AuthContext";
import { useCurrentQuestion } from "../../context/CurrentQuestionContext";

const Header = ({
  onNotificationsClick,
  onInviteClick,
  onMenuSelect,
  className = "",
  bgColor = "#9105C6",
  iconColor = "#F0E224",
}) => {
  const [open, setOpen] = useState(false);
  const menuRef = useRef(null);
  const navigate = useNavigate();
  const { logout, user } = useAuth()
  const { questionId } = useCurrentQuestion();

  useEffect(() => {
    const handler = (e) => {
      if (!menuRef.current?.contains(e.target)) setOpen(false);
    };
    document.addEventListener("mousedown", handler);
    return () => document.removeEventListener("mousedown", handler);
  }, []);

  const IconButton = ({ children, square = true, active = false, ...props }) => (
    <button
      {...props}
      className={[
        "grid place-items-center w-10 h-10 transition focus:outline-none",
        "focus-visible:ring-2 focus-visible:ring-[#F0E224]/70",
        square ? "rounded-xl" : "rounded-full",
        active ? "bg-[#3A0250]" : "hover:bg-[#3A0250]",
      ].join(" ")}
      style={{ color: iconColor }}
    >
      {children}
    </button>
  );

  const getInitials = () => {
    if (user?.firstName && user?.lastName) {
      return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();
    }
    if (user?.firstName) {
      return user.firstName[0].toUpperCase();
    }
    if (user?.email) {
      return user.email[0].toUpperCase();
    }
    return "?";
  };

  const initials = getInitials();


  return (
    <header className="w-full h-[72px]" style={{ backgroundColor: bgColor }}>
      <div
        className={`mx-auto flex items-center justify-between h-full px-4 gap-2 ${className}`}
      >
        {/* Left: logo */}
        <div className="flex items-center gap-3">
          {/* Replace src later */}
          <img
            loading="lazy"
            src="/logo-sm.svg"
            alt="Logo"
            className="object-contain z-20 shrink-0 self-stretch my-auto aspect-[2.72] w-[98px]"
          />
        </div>

        {/* Right: icon cluster */}
        <div className="flex items-center gap-2">
          {/* Bell (Notifications) */}
          <IconButton
            aria-label="Notifications"
            onClick={(e) => {
              navigate("/notification");
            }}
            title="Notifications"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clipPath="url(#clip0_680_1110)">
                <path d="M23.4 16.0801L22.92 15.8281C21.534 15.0983 20.0438 13.6456 20.0438 12.1756V9.7501C20.0438 6.3286 20.0438 0.600098 11.9438 0.600098C3.84754 0.600098 3.84754 6.3301 3.84754 9.7501V12.1756C3.84754 13.7296 2.47954 15.1576 1.20754 15.8281L0.727539 16.0816V18.9001H7.74754C7.74304 18.9758 7.72729 19.0501 7.72729 19.1258C7.73104 21.4853 9.64204 23.3971 12.0015 23.4001C14.361 23.3963 16.2728 21.4853 16.2773 19.1258C16.2773 19.0501 16.2615 18.9751 16.257 18.8993H23.4008L23.4 16.0801ZM14.4758 19.1258C14.4735 20.4923 13.3665 21.5986 12 21.6001C10.6335 21.5986 9.52654 20.4916 9.52429 19.1258C9.52429 19.0516 9.55654 18.9758 9.56404 18.9001H14.436C14.4435 18.9758 14.4758 19.0516 14.4758 19.1258ZM2.59579 17.1001C4.18954 16.0681 5.64754 14.2538 5.64754 12.1756V9.7501C5.64754 5.5861 6.11329 2.4001 11.946 2.4001C17.7818 2.4001 18.246 5.5861 18.246 9.7501V12.1756C18.246 14.1878 19.8165 16.0231 21.528 17.1001H2.59354H2.59579Z" fill="currentColor" />
              </g>
              <defs>
                <clipPath id="clip0_680_1110">
                  <rect width="24" height="24" fill="white" />
                </clipPath>
              </defs>
            </svg>

          </IconButton>

          {/* Invite (person + plus) */}
          <IconButton
            aria-label="Invite"
            onClick={(e) => {
              navigate("/send-invite");
            }}
            title="Invite"
          >
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clipPath="url(#clip0_680_1112)">
                <path d="M25.3258 28.686V29.0002H23.5258V28.686C23.5258 23.3445 23.5258 23.2545 17 23.2545C10.4758 23.2545 10.4758 23.2545 10.4758 29.0002H8.67578C8.67578 22.2202 9.50003 21.5002 17 21.5002C24.0658 21.5002 25.31 21.9802 25.3258 28.686ZM12.5758 14.9902C12.5645 14.871 12.5578 14.7322 12.5578 14.5927C12.5578 12.1657 14.4808 10.188 16.886 10.1002H16.8943C16.9558 10.0972 17.0278 10.0957 17.1005 10.0957C18.2743 10.0957 19.3393 10.5607 20.1215 11.316L20.12 11.3145C20.9548 12.15 21.4783 13.2967 21.5 14.5657V14.5702C21.5068 14.6617 21.5105 14.769 21.5105 14.877C21.5105 16.1797 20.9728 17.3572 20.1073 18.1995L20.1065 18.2002C19.3258 18.9472 18.2735 19.416 17.1118 19.4445H17.1065H17.0008C16.9775 19.4452 16.9498 19.4452 16.9228 19.4452C14.522 19.4452 12.575 17.499 12.575 15.0975C12.575 15.06 12.5758 15.0217 12.5765 14.9842V14.9895L12.5758 14.9902ZM14.3758 14.9902C14.3728 15.0367 14.3713 15.0907 14.3713 15.1455C14.3713 15.8317 14.6473 16.4527 15.095 16.9042C15.5953 17.412 16.289 17.6805 17.0008 17.6445C17.705 17.6362 18.3425 17.358 18.8165 16.9087L18.815 16.9102C19.3933 16.2982 19.6775 15.468 19.595 14.6302C19.595 14.619 19.595 14.6062 19.595 14.5927C19.595 13.815 19.2995 13.1055 18.8135 12.5722L18.8158 12.5745C18.368 12.1552 17.765 11.898 17.1013 11.898C17.066 11.898 17.03 11.8987 16.9948 11.9002H17C16.9963 11.9002 16.9925 11.9002 16.988 11.9002C15.5293 11.9002 14.3465 13.083 14.3465 14.5417C14.3465 14.679 14.357 14.814 14.3773 14.9452L14.3758 14.9302V14.9902ZM32 17.6002H28.4V14.0002H26.6V17.6002H23V19.4002H26.6V23.0002H28.4V19.4002H32V17.6002Z" fill="currentColor" />
              </g>
              <defs>
                <clipPath id="clip0_680_1112">
                  <rect width="24" height="24" fill="white" transform="translate(8 8)" />
                </clipPath>
              </defs>
            </svg>
          </IconButton>

          {/* 3 dots (menu) */}
          <div className="relative" ref={menuRef}>
            <IconButton
              aria-label="More options"
              onClick={() => setOpen((v) => !v)}
              title="More"
              active={open}
            >
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 20C14 21.242 12.9927 22.25 11.7507 22.25C10.5087 22.25 9.50146 21.2435 9.50146 20.0015V20.0007C9.50146 18.7587 10.5087 17.7515 11.7507 17.7515C12.9927 17.7515 14 18.758 14 20ZM20 17.75H19.9992C18.7572 17.75 17.75 18.7572 17.75 19.9992C17.75 21.2412 18.7565 22.2485 19.9985 22.2485C21.2405 22.2485 22.2485 21.2412 22.2485 19.9992C22.2485 18.7572 21.242 17.75 20 17.75ZM28.25 17.75C27.008 17.75 26 18.7572 26 19.9992C26 21.2412 27.0065 22.2485 28.2485 22.2485H28.2492C29.4912 22.2485 30.4985 21.2412 30.4985 19.9992C30.4985 18.7572 29.492 17.75 28.25 17.75Z" fill="currentColor" />
              </svg>
            </IconButton>

            {open && (
              <div
                className="absolute right-0 w-72 rounded-2xl bg-white shadow-lg border border-gray-200 overflow-hidden z-50"
                role="menu"
              >
                {/* Profile header */}
                <div className="flex items-center gap-3 px-4 py-3 border-b border-gray-200">
                  <div className="h-10 w-10 rounded-full bg-[#9105C6] text-[#F0E224] font-intro flex items-center justify-center font-semibold">
                    {initials}
                  </div>
                  <div className="flex flex-col items-start">
                    <span className="font-medium text-[#212121]">{user?.firstName} {user?.lastName}</span>
                    <span className="text-sm text-[#707070]">{user?.email}</span>
                  </div>
                </div>

                {/* Menu items */}
                <div className="flex flex-col py-1">
                  <button
                    className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-[#212121] text-sm"
                    onClick={() => {
                      navigate("/guidelines");
                      setOpen(false);
                    }}
                  >
                    <span className="text-lg"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M18.1132 2.93799L7.58822 17.3999L1.9751 11.7749L3.0251 10.7249L7.41197 15.0999L16.887 2.06299L18.1132 2.93799Z" fill="#212121" />
                    </svg>
                    </span> Posting guidelines
                  </button>

                  <button
                    className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-[#212121] text-sm"
                    onClick={() => {
                      const qs = questionId ? `?questionId=${questionId}` : "";
                      navigate(`/report${qs}`);
                      setOpen(false);
                    }}
                  >
                    <span className="text-lg"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M17.6484 4.1248C16.9309 2.8548 15.9015 1.83543 14.6615 1.1498L14.6221 1.1298C13.3252 0.41293 11.7702 0.0498047 10.0002 0.0498047C8.23211 0.0498047 6.68023 0.41168 5.38398 1.12855C4.10211 1.83293 3.07023 2.85355 2.37273 4.08731L2.35273 4.12543C1.65461 5.37543 1.30273 6.81356 1.30273 8.39731C1.30273 9.97231 1.65461 11.4073 2.35273 12.6592C3.06961 13.9292 4.09898 14.9486 5.33836 15.6336L5.37773 15.6536C5.73461 15.8536 6.11961 16.0254 6.52461 16.1704C6.96836 16.3304 7.37461 16.6336 7.70086 17.0486L9.99961 19.9604L12.2996 17.0473C12.599 16.6561 12.9971 16.3548 13.4577 16.1786L13.4759 16.1723C13.8796 16.0254 14.2659 15.8523 14.6209 15.6536C15.9002 14.9486 16.9296 13.9292 17.6277 12.6973L17.6477 12.6592C18.3446 11.4029 18.6977 9.97043 18.6977 8.39731C18.6977 6.81543 18.3446 5.37918 17.6477 4.12543L17.6484 4.1248ZM16.3371 11.9317C15.7621 12.9604 14.9621 13.7498 13.8921 14.3448C13.6334 14.4923 13.3296 14.6323 13.0134 14.7473L12.9709 14.7611C12.2196 15.0429 11.5934 15.5111 11.1277 16.1104L11.1209 16.1198L9.99961 17.5367L8.87961 16.1186C8.40711 15.5104 7.78148 15.0423 7.06023 14.7692L7.03148 14.7598C6.67023 14.6298 6.36461 14.4886 6.07398 14.3254L6.10586 14.3417C5.07336 13.7748 4.24273 12.9536 3.67961 11.9604L3.66336 11.9298C3.09148 10.9017 2.80023 9.71168 2.80023 8.39606C2.80023 7.07105 3.09148 5.87981 3.66336 4.85418C4.24273 3.8298 5.07461 3.00793 6.07648 2.4573L6.10836 2.44105C7.17961 1.8498 8.48961 1.5473 9.99961 1.5473C11.5115 1.5473 12.8234 1.84918 13.8934 2.44105C14.9284 3.00543 15.7602 3.82855 16.3196 4.82543L16.3352 4.85605C16.9065 5.88418 17.1984 7.07481 17.1984 8.39731C17.1984 9.71231 16.9065 10.9023 16.3365 11.9311L16.3371 11.9317Z" fill="#212121" />
                      <path d="M8.74943 12.1237C8.74943 12.4568 8.88818 12.7581 9.11193 12.9718L9.11256 12.9712C9.33943 13.195 9.65193 13.3331 9.99631 13.3331H10.0007C10.2257 13.3331 10.4376 13.2831 10.6257 13.17L10.6313 13.1668C10.8119 13.0581 10.9638 12.9062 11.0757 12.72C11.1876 12.52 11.2507 12.32 11.2507 12.0831C11.2507 11.745 11.1257 11.445 10.8757 11.2081C10.6257 10.9712 10.3513 10.8462 10.0013 10.8462H9.98631C9.30318 10.8462 8.75006 11.3993 8.75006 12.0818C8.74943 12.0956 8.74943 12.11 8.74943 12.1237Z" fill="#212121" />
                      <path d="M9.25006 3.95872H10.7501V8.95872H9.25006V3.95872Z" fill="#212121" />
                    </svg>
                    </span> Report question
                  </button>

                  <button
                    className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-[#212121] text-sm"
                    onClick={() => {
                      navigate("/help");
                      setOpen(false);
                    }}
                  >
                    <span className="text-lg"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <g clip-path="url(#clip0_865_2632)">
                        <path d="M10 19.5C8.125 19.5 6.45 19.1 5.025 18.3131C3.59938 17.5263 2.45687 16.3794 1.69687 14.9938L1.675 14.9506C0.886875 13.5256 0.5 11.8506 0.5 9.97565C0.5 8.10065 0.9 6.43877 1.68813 5.02564C2.4775 3.60564 3.61812 2.46502 4.995 1.69752L5.03813 1.67564C6.46312 0.88877 8.125 0.48877 10.0119 0.48877C11.9 0.48877 13.5631 0.887519 14.9881 1.67564C16.405 2.46877 17.5444 3.60814 18.315 4.98252L18.3369 5.02564C19.125 6.43752 19.525 8.10065 19.525 9.97565C19.525 11.8506 19.125 13.5256 18.35 14.9506C17.5644 16.3775 16.4231 17.5225 15.0431 18.2919L15 18.3138C13.5881 19.1006 11.9119 19.5006 10.025 19.5006L10 19.5ZM10 2.00002C8.375 2.00002 6.95 2.33814 5.76187 3.00002C4.59437 3.65564 3.655 4.59502 3.01812 5.72752L3 5.76314C2.33687 6.95002 2.01188 8.37502 2.01188 9.98814C2.01188 11.6 2.35 13.0381 3.01187 14.2381C3.66375 15.4125 4.60375 16.3569 5.73937 16.995L5.775 17.0131C6.96187 17.675 8.4 18.0131 10.0119 18.0131C11.625 18.0131 13.0619 17.675 14.2619 17.0131C15.4356 16.3606 16.3769 15.415 17.0069 14.2738L17.025 14.2381C17.6881 13.0381 18.025 11.6131 18.025 9.98814C18.025 8.36189 17.6881 6.95002 17.0381 5.76189C16.3863 4.59189 15.4456 3.65127 14.3106 3.01814L14.275 3.00002C13.0881 2.33689 11.65 2.00002 10.0381 2.00002H10ZM8.975 11.4381V11.325C8.975 10.8131 9.025 10.4119 9.13688 10.1C9.23688 9.80002 9.38688 9.55002 9.575 9.37502C9.76188 9.18689 10 9.02502 10.275 8.86189C10.4619 8.75002 10.6369 8.6369 10.7869 8.5119C10.9369 8.3869 11.05 8.23689 11.1369 8.07502C11.225 7.91189 11.2619 7.73689 11.2619 7.53689C11.2619 7.53189 11.2619 7.52627 11.2619 7.52002C11.2619 7.31127 11.1963 7.11752 11.0844 6.95877L11.0863 6.96189C10.9681 6.79627 10.8125 6.66502 10.6313 6.57814L10.6244 6.57502C10.4356 6.48814 10.2144 6.43689 9.98187 6.43689C9.97937 6.43689 9.97687 6.43689 9.97437 6.43689H9.975C9.75 6.43689 9.55 6.47502 9.35 6.56189C9.15063 6.64689 8.98562 6.78002 8.86437 6.94689L8.86187 6.95002C8.73687 7.12502 8.66187 7.33689 8.65 7.61189H7C7.01187 7.07502 7.16187 6.62502 7.425 6.26189C7.695 5.89689 8.06 5.61689 8.48375 5.45502L8.5 5.44939C8.93313 5.27564 9.43563 5.17439 9.96125 5.17439C9.96625 5.17439 9.97062 5.17439 9.97563 5.17439H9.975C10.5619 5.17439 11.0869 5.27439 11.5369 5.46127C11.9869 5.64939 12.3369 5.92439 12.5869 6.27439C12.8369 6.62439 12.9631 7.03627 12.9631 7.51127C12.9631 7.83627 12.9131 8.12439 12.7869 8.37439C12.675 8.6244 12.5119 8.84939 12.3119 9.04939C12.1 9.24939 11.8619 9.42439 11.575 9.5744C11.325 9.71252 11.125 9.86252 10.9619 10.0113C10.8088 10.1575 10.6888 10.3375 10.615 10.5394L10.6119 10.5488C10.5406 10.7581 10.4987 10.9988 10.4987 11.2494C10.4987 11.2713 10.4987 11.2931 10.5 11.315V11.3119V11.4238H8.96187L8.975 11.4381ZM9.76188 14.8119C9.75688 14.8119 9.75125 14.8119 9.74563 14.8119C9.46625 14.8119 9.2125 14.7025 9.02437 14.5244L9.025 14.525C8.83312 14.3644 8.71187 14.1244 8.71187 13.8563C8.71187 13.8494 8.71187 13.8431 8.71187 13.8363V13.8375C8.71187 13.5625 8.81187 13.3506 9.025 13.1625C9.225 12.9756 9.475 12.8756 9.76188 12.8756C10.05 12.8756 10.2881 12.9756 10.5 13.1625C10.6919 13.3225 10.8131 13.5619 10.8131 13.8294C10.8131 13.8325 10.8131 13.835 10.8131 13.8381V13.8375C10.8131 14.02 10.7569 14.1888 10.66 14.3281L10.6619 14.325C10.5631 14.475 10.4381 14.5869 10.275 14.675C10.1281 14.7538 9.95312 14.8 9.76812 14.8C9.76188 14.8 9.75562 14.8 9.74937 14.8H9.75062L9.76188 14.8119Z" fill="#212121" />
                      </g>
                      <defs>
                        <clipPath id="clip0_865_2632">
                          <rect width="20" height="20" fill="white" />
                        </clipPath>
                      </defs>
                    </svg>
                    </span> Help
                  </button>

                  <button
                    className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-[#212121] text-sm"
                    onClick={() => {
                      logout();
                      setOpen(false);
                    }}
                  >
                    <span className="text-lg"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M18.5631 10.0002L12.725 15.8384L11.6619 14.7752L15.6881 10.7502H1.25V9.25023H15.6881L11.6619 5.22523L12.725 4.16211L18.5631 10.0002Z" fill="#212121" />
                    </svg>
                    </span> Log out
                  </button>
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    </header>
  );
};

export default Header;
